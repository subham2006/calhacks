{
  "version": 3,
  "sources": ["../../../../src/lib/shapes/video/VideoShapeUtil.tsx"],
  "sourcesContent": ["/* eslint-disable react-hooks/rules-of-hooks */\nimport {\n\tBaseBoxShapeUtil,\n\tEditor,\n\tHTMLContainer,\n\tMediaHelpers,\n\tTLVideoShape,\n\ttoDomPrecision,\n\tuseEditorComponents,\n\tuseIsEditing,\n\tvideoShapeMigrations,\n\tvideoShapeProps,\n} from '@tldraw/editor'\nimport classNames from 'classnames'\nimport { ReactEventHandler, useCallback, useEffect, useRef, useState } from 'react'\nimport { BrokenAssetIcon } from '../shared/BrokenAssetIcon'\nimport { HyperlinkButton } from '../shared/HyperlinkButton'\nimport { useAsset } from '../shared/useAsset'\nimport { usePrefersReducedMotion } from '../shared/usePrefersReducedMotion'\n\n/** @public */\nexport class VideoShapeUtil extends BaseBoxShapeUtil<TLVideoShape> {\n\tstatic override type = 'video' as const\n\tstatic override props = videoShapeProps\n\tstatic override migrations = videoShapeMigrations\n\n\toverride canEdit() {\n\t\treturn true\n\t}\n\toverride isAspectRatioLocked() {\n\t\treturn true\n\t}\n\n\toverride getDefaultProps(): TLVideoShape['props'] {\n\t\treturn {\n\t\t\tw: 100,\n\t\t\th: 100,\n\t\t\tassetId: null,\n\t\t\ttime: 0,\n\t\t\tplaying: true,\n\t\t\turl: '',\n\t\t}\n\t}\n\n\tcomponent(shape: TLVideoShape) {\n\t\tconst { editor } = this\n\t\tconst showControls = editor.getShapeGeometry(shape).bounds.w * editor.getZoomLevel() >= 110\n\t\tconst { asset, url } = useAsset({\n\t\t\tshapeId: shape.id,\n\t\t\tassetId: shape.props.assetId,\n\t\t\twidth: shape.props.w,\n\t\t})\n\t\tconst isEditing = useIsEditing(shape.id)\n\t\tconst prefersReducedMotion = usePrefersReducedMotion()\n\t\tconst { Spinner } = useEditorComponents()\n\n\t\tconst rVideo = useRef<HTMLVideoElement>(null!)\n\n\t\tconst [isLoaded, setIsLoaded] = useState(false)\n\n\t\tconst [isFullscreen, setIsFullscreen] = useState(false)\n\n\t\tuseEffect(() => {\n\t\t\tconst fullscreenChange = () => setIsFullscreen(document.fullscreenElement === rVideo.current)\n\t\t\tdocument.addEventListener('fullscreenchange', fullscreenChange)\n\n\t\t\treturn () => document.removeEventListener('fullscreenchange', fullscreenChange)\n\t\t})\n\n\t\tconst handleLoadedData = useCallback<ReactEventHandler<HTMLVideoElement>>((e) => {\n\t\t\tconst video = e.currentTarget\n\t\t\tif (!video) return\n\n\t\t\tsetIsLoaded(true)\n\t\t}, [])\n\n\t\t// If the current time changes and we're not editing the video, update the video time\n\t\tuseEffect(() => {\n\t\t\tconst video = rVideo.current\n\t\t\tif (!video) return\n\n\t\t\tif (isEditing) {\n\t\t\t\tif (document.activeElement !== video) {\n\t\t\t\t\tvideo.focus()\n\t\t\t\t}\n\t\t\t}\n\t\t}, [isEditing, isLoaded])\n\n\t\tuseEffect(() => {\n\t\t\tif (prefersReducedMotion) {\n\t\t\t\tconst video = rVideo.current\n\t\t\t\tif (!video) return\n\t\t\t\tvideo.pause()\n\t\t\t\tvideo.currentTime = 0\n\t\t\t}\n\t\t}, [rVideo, prefersReducedMotion])\n\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<HTMLContainer\n\t\t\t\t\tid={shape.id}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tcolor: 'var(--color-text-3)',\n\t\t\t\t\t\tbackgroundColor: asset ? 'transparent' : 'var(--color-low)',\n\t\t\t\t\t\tborder: asset ? 'none' : '1px solid var(--color-low-border)',\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div className=\"tl-counter-scaled\">\n\t\t\t\t\t\t<div className=\"tl-video-container\">\n\t\t\t\t\t\t\t{!asset ? (\n\t\t\t\t\t\t\t\t<BrokenAssetIcon />\n\t\t\t\t\t\t\t) : Spinner && !asset.props.src ? (\n\t\t\t\t\t\t\t\t<Spinner />\n\t\t\t\t\t\t\t) : url ? (\n\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t<video\n\t\t\t\t\t\t\t\t\t\tref={rVideo}\n\t\t\t\t\t\t\t\t\t\tstyle={\n\t\t\t\t\t\t\t\t\t\t\tisEditing\n\t\t\t\t\t\t\t\t\t\t\t\t? { pointerEvents: 'all' }\n\t\t\t\t\t\t\t\t\t\t\t\t: !isLoaded\n\t\t\t\t\t\t\t\t\t\t\t\t\t? { display: 'none' }\n\t\t\t\t\t\t\t\t\t\t\t\t\t: undefined\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tclassName={classNames('tl-video', `tl-video-shape-${shape.id.split(':')[1]}`, {\n\t\t\t\t\t\t\t\t\t\t\t'tl-video-is-fullscreen': isFullscreen,\n\t\t\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t\t\t\twidth=\"100%\"\n\t\t\t\t\t\t\t\t\t\theight=\"100%\"\n\t\t\t\t\t\t\t\t\t\tdraggable={false}\n\t\t\t\t\t\t\t\t\t\tplaysInline\n\t\t\t\t\t\t\t\t\t\tautoPlay\n\t\t\t\t\t\t\t\t\t\tmuted\n\t\t\t\t\t\t\t\t\t\tloop\n\t\t\t\t\t\t\t\t\t\tdisableRemotePlayback\n\t\t\t\t\t\t\t\t\t\tdisablePictureInPicture\n\t\t\t\t\t\t\t\t\t\tcontrols={isEditing && showControls}\n\t\t\t\t\t\t\t\t\t\tonLoadedData={handleLoadedData}\n\t\t\t\t\t\t\t\t\t\thidden={!isLoaded}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<source src={url} />\n\t\t\t\t\t\t\t\t\t</video>\n\t\t\t\t\t\t\t\t\t{!isLoaded && Spinner && <Spinner />}\n\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t) : null}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</HTMLContainer>\n\t\t\t\t{'url' in shape.props && shape.props.url && (\n\t\t\t\t\t<HyperlinkButton url={shape.props.url} zoomLevel={editor.getZoomLevel()} />\n\t\t\t\t)}\n\t\t\t</>\n\t\t)\n\t}\n\n\tindicator(shape: TLVideoShape) {\n\t\treturn <rect width={toDomPrecision(shape.props.w)} height={toDomPrecision(shape.props.h)} />\n\t}\n\n\toverride async toSvg(shape: TLVideoShape) {\n\t\tconst image = await serializeVideo(this.editor, shape)\n\t\tif (!image) return null\n\t\treturn <image href={image} width={shape.props.w} height={shape.props.h} />\n\t}\n}\n\nasync function serializeVideo(editor: Editor, shape: TLVideoShape): Promise<string | null> {\n\tconst assetUrl = await editor.resolveAssetUrl(shape.props.assetId, {\n\t\tshouldResolveToOriginal: true,\n\t})\n\tif (!assetUrl) return null\n\n\tconst video = await MediaHelpers.loadVideo(assetUrl)\n\treturn MediaHelpers.getVideoFrameAsDataUrl(video, 0)\n}\n"],
  "mappings": "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",
  "names": ["classNames"]
}
